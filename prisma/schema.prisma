// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Recipe {
  id          String   @id @default(uuid())
  title       String
  description String?
  ingredients String   // Stored as JSON string
  instructions String  // Stored as JSON string
  calories    Int
  proteins    Int
  carbs       Int
  fats        Int
  prepTime    Int?
  imageUrl    String?
  source      String   @default("AI") // "AI", "USER"
  tags        String?  // Stored as JSON string: ["vegan", "keto", "breakfast"]
  
  // Créateur de la recette (pour les recettes utilisateur)
  creatorId   String?
  creatorName String?
  
  // Plat de la semaine
  isDishOfTheWeek Boolean @default(false)
  dishOfTheWeekAt DateTime?
  
  ratings     Rating[]
  favorites   Favorite[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([creatorId])
  @@index([isDishOfTheWeek])
}

model Rating {
  id        String   @id @default(uuid())
  score     Int      // 1-5
  comment   String?
  
  // Feedback détaillé pour ML
  taste          Int?     // 1-5 (goût)
  difficulty     Int?     // 1-5 (difficulté perçue)
  wouldMakeAgain Boolean? // Referiez-vous cette recette ?
  tags           String?  // JSON array: ["trop_salé", "parfait", "rapide"]
  
  recipeId  String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  userId    String   @default("default")
  
  createdAt   DateTime @default(now())
}

model Favorite {
  id        String   @id @default(uuid())
  
  recipeId  String
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  
  userId    String   @default("default")
  
  createdAt DateTime @default(now())
  
  @@unique([recipeId, userId])
}

model CoachConversation {
  id        String   @id @default(uuid())
  
  userId    String   @default("default")
  userMessage      String
  assistantResponse String
  
  // Contexte nutritionnel au moment de la conversation
  nutritionContext String?  // Stored as JSON string
  
  // Feedback utilisateur (pour l'apprentissage)
  helpful   Boolean?
  rating    Int?     // 1-5
  
  createdAt DateTime @default(now())
  
  @@index([userId, createdAt])
}

model UserProfile {
  id        String   @id @default(uuid())
  
  userId    String   @unique @default("default")
  
  // Objectifs
  goals     String?  // Stored as JSON: ["perte_poids", "prise_muscle", "maintien"]
  
  // Préférences alimentaires
  preferences String?  // Stored as JSON: ["végétarien", "sans_gluten"]
  
  // Restrictions/Allergies
  restrictions String?  // Stored as JSON: ["lactose", "arachides"]
  
  // Données personnelles
  age       Int?
  weight    Float?
  height    Float?
  activityLevel String?  // "sedentaire", "modere", "actif", "tres_actif"
  
  // Objectifs nutritionnels
  targetCalories Int?
  targetProteins Int?
  targetCarbs    Int?
  targetFats     Int?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// SYSTÈME DE RANKING UTILISATEURS
// ==========================================

model UserRanking {
  id        String   @id @default(uuid())
  
  userId    String   @unique
  userName  String   @default("Chef Anonyme")
  avatarUrl String?
  
  // Statistiques pour le calcul du score
  recipesCount      Int @default(0)    // Nombre de recettes créées
  recipesWithPhotos Int @default(0)    // Recettes avec photos
  totalRatingsReceived Int @default(0) // Nombre total de notes reçues
  averageRating     Float @default(0)  // Note moyenne des recettes
  dishOfTheWeekCount Int @default(0)   // Nombre de fois "plat de la semaine"
  
  // Score calculé et niveau
  totalPoints Int @default(0)          // Points totaux
  level       Int @default(1)          // Niveau 1, 2 ou 3
  
  // Badges et accomplissements
  badges      String? // JSON: ["first_recipe", "top_chef", "photo_master", etc.]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([totalPoints])
  @@index([level])
}

// ==========================================
// MODÈLES POUR LE FEEDBACK ET ML
// ==========================================

model MealPlan {
  id        String   @id @default(uuid())
  
  userId    String   @default("default")
  
  // Données du plan (JSON)
  planData  String   // JSON: { days: [...], preferences: {...} }
  
  // Métadonnées
  startDate DateTime?
  endDate   DateTime?
  userGoal  String?
  targetCalories Int?
  dietType  String?
  
  feedback  MealPlanFeedback[]
  
  createdAt DateTime @default(now())
  
  @@index([userId, createdAt])
}

model MealPlanFeedback {
  id        String   @id @default(uuid())
  
  mealPlanId String
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  
  userId    String   @default("default")
  
  // Scores de satisfaction (1-5)
  rating        Int?   // Note globale
  variety       Int?   // Variété des repas
  practicality  Int?   // Praticité
  satisfying    Boolean? // Satisfaisant ?
  
  comment       String?
  improvedMeals String?  // JSON: [{ day, meal, reason }]
  
  createdAt DateTime @default(now())
}

model MealHistory {
  id        String   @id @default(uuid())
  
  userId    String   @default("default")
  recipeId  String?
  
  // Identifiant du repas
  mealName  String
  mealType  String   // "breakfast", "lunch", "dinner", "snack"
  
  // Macros
  calories  Int
  proteins  Int
  carbs     Int
  fats      Int
  
  // Contexte
  wasPlanned Boolean @default(false)
  liked      Boolean?
  dayOfWeek  Int?     // 0-6 (dimanche-samedi)
  
  createdAt DateTime @default(now())
  
  @@index([userId, mealType])
  @@index([userId, liked])
}

// ==========================================
// SUIVI DU POIDS ET WEARABLES
// ==========================================

model WeightEntry {
  id        String   @id @default(uuid())
  
  userId    String   @default("default")
  
  weight    Float    // Poids en kg
  bodyFat   Float?   // % de masse grasse (si disponible)
  muscleMass Float?  // % de masse musculaire (si disponible)
  waterPercentage Float? // % d'eau (si disponible)
  bmi       Float?   // IMC calculé
  
  // Source de la mesure
  source    String   @default("manual") // "manual", "apple_health", "google_fit", "withings", "xiaomi", etc.
  deviceName String? // Nom de l'appareil connecté
  
  // Métadonnées
  notes     String?
  measuredAt DateTime @default(now()) // Date/heure de la mesure
  
  createdAt DateTime @default(now())
  
  @@index([userId, measuredAt])
  @@index([userId, source])
}

model ConnectedDevice {
  id        String   @id @default(uuid())
  
  userId    String   @default("default")
  
  // Infos de l'appareil
  deviceType    String  // "scale", "watch", "band"
  deviceBrand   String  // "withings", "xiaomi", "apple", "garmin", etc.
  deviceName    String  // Nom personnalisé ou modèle
  
  // Connexion
  platform      String  // "apple_health", "google_fit", "direct_api"
  isConnected   Boolean @default(true)
  lastSyncAt    DateTime?
  
  // Permissions
  permissions   String? // JSON: ["weight", "body_fat", "steps", etc.]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, deviceType, deviceBrand])
  @@index([userId])
}

// Repas validés/modifiés par l'utilisateur
model ValidatedMeal {
  id        String   @id @default(uuid())
  
  userId    String   @default("default")
  recipeId  String?
  
  // Infos du repas
  mealName    String
  mealType    String     // "breakfast", "lunch", "dinner", "snack"
  description String?
  
  // Macros
  calories  Int
  proteins  Int
  carbs     Int
  fats      Int
  prepTime  Int?
  
  // Statut et dates
  status        String     // "validated", "skipped", "moved"
  originalDate  DateTime   // Date prévue initialement
  actualDate    DateTime?  // Date réelle (si déplacé ou validé)
  
  // Contexte du plan
  mealPlanId    String?
  dayIndex      Int?       // Index du jour dans le plan (0-6)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId, actualDate])
  @@index([userId, status])
  @@index([mealPlanId])
}

// ==========================================
// MODE FAMILLE - ARCHITECTURE PROFESSIONNELLE
// ==========================================

// Famille - Groupe principal
model Family {
  id        String   @id @default(uuid())
  
  // Informations famille
  name      String   // "Famille Dupont"
  adminId   String   // Utilisateur créateur/admin
  
  // Configuration
  maxMembers    Int @default(6)        // Limite membres (plan pricing)
  subscriptionTier String @default("starter") // "starter", "plus", "premium"
  
  // Préférences globales
  weeklyBudget  Float?                 // Budget courses hebdomadaire
  sharedGoals   String?                // JSON: ["health", "economy", "ecology"]
  
  // Gestion invitations
  inviteCode    String @unique         // Code pour rejoindre (ex: "DUPONT2025")
  invitesUsed   Int @default(0)
  
  // Relations
  members       FamilyMember[]
  mealPlans     FamilyMealPlan[]
  shoppingLists FamilyShoppingList[]
  challenges    FamilyChallenge[]
  
  // Métadonnées
  isActive      Boolean @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([adminId])
  @@index([inviteCode])
}

// Membre de la famille avec profil nutritionnel complet
model FamilyMember {
  id        String   @id @default(uuid())
  
  familyId  String
  family    Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  userId    String   // Lien vers User (si compte créé)
  
  // Informations personnelles
  firstName String
  nickname  String?                    // Surnom affectueux
  avatarUrl String?                    // Photo profil
  
  // Profil démographique
  birthDate DateTime                   // Pour calcul âge précis
  gender    String                     // "male", "female", "other"
  role      String                     // "admin", "parent", "child", "teen", "senior"
  
  // Données anthropométriques
  height    Float?                     // cm
  weight    Float?                     // kg
  targetWeight Float?                  // kg (si objectif poids)
  
  // Niveau activité physique
  activityLevel String @default("moderate") // "sedentary", "light", "moderate", "active", "athlete"
  sportsFrequency Int?                 // Fois par semaine
  
  // Objectifs nutritionnels personnalisés
  primaryGoal    String?               // "weight_loss", "muscle_gain", "maintenance", "growth"
  targetCalories Int?                  // kcal/jour (calculé automatiquement)
  targetProteins Int?                  // g/jour
  targetCarbs    Int?                  // g/jour
  targetFats     Int?                  // g/jour
  
  // Spécificités médicales/nutritionnelles
  allergies      String?               // JSON: ["lactose", "gluten", "arachides"]
  intolerances   String?               // JSON: ["fructose", "histamine"]
  medicalConditions String?            // JSON: ["diabetes_t2", "hypertension", "celiac"]
  medications    String?               // JSON: [{name, impact_nutrition}]
  
  // Préférences alimentaires
  dietType      String @default("omnivore") // "omnivore", "vegetarian", "vegan", "pescatarian", "keto", "paleo"
  likedFoods    String?                // JSON: ["pasta", "chicken", "broccoli"]
  dislikedFoods String?                // JSON: ["liver", "eggplant"]
  
  // Données santé suivies
  healthTracking String?                // JSON: {last_checkup, blood_pressure, glucose}
  growthData     String?                // JSON: courbe croissance (pour enfants)
  
  // Statut et permissions
  canEditMealPlan Boolean @default(true)
  canSeeFamilyData Boolean @default(true)
  receiveNotifications Boolean @default(true)
  isActive       Boolean @default(true)
  
  // Relations
  mealLogs       FamilyMemberMealLog[]
  weightLogs     FamilyMemberWeightLog[]
  
  // Métadonnées
  joinedAt      DateTime @default(now())
  lastActiveAt  DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([familyId, userId])
  @@index([familyId])
  @@index([userId])
  @@index([role])
}

// Plan de repas familial (multi-profils)
model FamilyMealPlan {
  id        String   @id @default(uuid())
  
  familyId  String
  family    Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // Informations plan
  name      String                     // "Semaine du 1er janvier"
  planMode  String   @default("unified") // "unified", "hybrid", "individual"
  
  // Période
  startDate DateTime
  endDate   DateTime
  
  // Configuration
  mealsPerDay  Int @default(4)         // breakfast, lunch, snack, dinner
  daysCount    Int @default(7)
  
  // Données du plan (JSON avec structure pour chaque membre)
  planData  String                     // JSON: {members: {memberId: {day1: {breakfast: {...}}}}}
  
  // Objectifs et contraintes
  totalBudget   Float?
  targetVariety Int?                   // Score variété visé (0-100)
  preferences   String?                // JSON: {avoid_waste, local_products, seasonal}
  
  // Statistiques
  totalCalories      Int?              // Somme famille par jour
  estimatedCost      Float?
  varietyScore       Int?              // 0-100
  nutritionalBalance Int?              // 0-100 (équilibre global)
  
  // Statut
  status     String @default("draft")  // "draft", "active", "completed", "archived"
  generatedBy String?                  // "ai", "manual", "template"
  
  // Feedback
  rating     Int?                      // 1-5 étoiles
  feedback   String?                   // Commentaires famille
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId, status])
  @@index([startDate, endDate])
}

// Journal alimentaire par membre (suivi médical)
model FamilyMemberMealLog {
  id        String   @id @default(uuid())
  
  memberId  String
  member    FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  // Identifiant repas
  mealDate  DateTime
  mealType  String                     // "breakfast", "lunch", "snack", "dinner"
  mealName  String
  
  // Composition nutritionnelle
  calories  Int
  proteins  Int
  carbs     Int
  fats      Int
  fiber     Int?
  sugar     Int?
  salt      Int?                       // mg
  
  // Micronutriments (pour suivi médical)
  calcium   Int?                       // mg
  iron      Int?                       // mg
  vitaminD  Int?                       // UI
  vitaminC  Int?                       // mg
  
  // Contexte
  portion   Float @default(1.0)        // Taille portion (1.0 = normale)
  location  String?                    // "home", "school", "restaurant"
  wasPlanned Boolean @default(false)   // Issu du plan ou imprévu
  
  // Satisfaction
  liked     Boolean?
  comment   String?
  
  // Photo (pour suivi visuel)
  photoUrl  String?
  
  createdAt DateTime @default(now())
  
  @@index([memberId, mealDate])
  @@index([mealDate])
}

// Suivi poids et courbes de croissance (médical)
model FamilyMemberWeightLog {
  id        String   @id @default(uuid())
  
  memberId  String
  member    FamilyMember @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  // Données mesure
  measuredAt DateTime
  weight    Float                      // kg
  height    Float?                     // cm (surtout pour enfants)
  
  // Composition corporelle (si disponible)
  bodyFat   Float?                     // %
  muscleMass Float?                    // %
  bmi       Float?                     // Calculé automatiquement
  
  // Courbes de croissance (enfants)
  growthPercentile Float?             // Percentile selon courbes INSERM
  heightPercentile Float?
  
  // Contexte
  source    String @default("manual")  // "manual", "smart_scale", "pediatrician"
  notes     String?
  
  createdAt DateTime @default(now())
  
  @@index([memberId, measuredAt])
}

// Liste de courses familiale partagée
model FamilyShoppingList {
  id        String   @id @default(uuid())
  
  familyId  String
  family    Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // Informations
  name      String                     // "Courses semaine 1"
  weekStartDate DateTime
  
  // Items (JSON agrégé)
  items     String                     // JSON: [{ingredient, quantity, unit, category, checked, assignedTo}]
  
  // Organisation
  categories String?                   // JSON: rayon ordering
  
  // Budget
  estimatedCost Float?
  actualCost    Float?
  
  // Collaboration
  sharedWith    String?                // JSON: [memberIds]
  lastModifiedBy String?
  
  // Statut
  status    String @default("active")  // "active", "shopping", "completed", "archived"
  completedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId, weekStartDate])
  @@index([status])
}

// Challenges familiaux (gamification)
model FamilyChallenge {
  id        String   @id @default(uuid())
  
  familyId  String
  family    Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  // Informations challenge
  title     String                     // "Semaine zéro gaspillage"
  description String?
  type      String                     // "nutrition", "ecology", "budget", "activity"
  icon      String?                    // Emoji ou icon name
  
  // Période
  startDate DateTime
  endDate   DateTime
  
  // Objectif
  goal      String                     // JSON: {type, target, current}
  reward    String?                    // "badge", "points", "real_prize"
  
  // Participants
  participants String?                 // JSON: [memberIds] ou "all"
  
  // Progression
  progress  Int @default(0)            // 0-100%
  status    String @default("active")  // "active", "completed", "failed", "cancelled"
  
  // Résultats
  completedAt DateTime?
  winner      String?                  // memberId si compétition
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId, status])
  @@index([endDate])
}

// Invitations famille (gestion sécurisée)
model FamilyInvitation {
  id        String   @id @default(uuid())
  
  familyId  String
  
  // Destinataire
  email     String
  firstName String?
  role      String @default("member")  // "parent", "child", "teen"
  
  // Sécurité
  token     String @unique             // Token unique pour accepter
  expiresAt DateTime
  
  // Statut
  status    String @default("pending") // "pending", "accepted", "declined", "expired"
  acceptedAt DateTime?
  declinedAt DateTime?
  
  // Métadonnées
  sentBy    String                     // userId qui a envoyé
  message   String?                    // Message personnalisé
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([familyId])
  @@index([email])
  @@index([token])
  @@index([status])
}

// Notifications famille (ciblées par membre)
model FamilyNotification {
  id        String   @id @default(uuid())
  
  familyId  String
  memberId  String?                    // null = toute la famille
  
  // Contenu
  type      String                     // "alert", "tip", "achievement", "reminder"
  title     String
  message   String
  icon      String?
  
  // Priorité et catégorie
  priority  String @default("normal")  // "low", "normal", "high", "urgent"
  category  String                     // "nutrition", "health", "activity", "budget"
  
  // Actions
  actionUrl String?
  actionLabel String?
  
  // Statut
  isRead    Boolean @default(false)
  readAt    DateTime?
  
  createdAt DateTime @default(now())
  
  @@index([familyId, memberId, isRead])
  @@index([createdAt])
}
