generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// NextAuth Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  
  // Profile fields
  firstName            String?
  lastName             String?
  birthDate            DateTime?
  gender               String?   // male, female, other
  height               Float?    // cm
  weight               Float?    // kg (current)
  targetWeight         Float?    // kg
  activityLevel        String?   // sedentary, light, moderate, active, athlete
  goal                 String?   // weight_loss, muscle_gain, etc.
  
  // Nutrition Targets
  dailyCaloriesTarget  Int?
  proteinTarget        Int?
  carbsTarget          Int?
  fatTarget            Int?

  // Diet & Cooking
  dietType             String?   // omnivore, vegetarian, etc.
  allergies            String?   // JSON string
  intolerances         String?   // JSON string
  dislikedFoods        String?   // JSON string
  likedFoods           String?   // JSON string
  
  cookingSkillLevel    String?   // beginner, intermediate, advanced
  cookingTimeWeekday   Int?      // minutes
  cookingTimeWeekend   Int?      // minutes
  weeklyBudget         Int?      // euros
  
  // Fasting (stored as JSON)
  fastingSchedule      String?   // JSON string { type, windowStart, ... }
  
  // App State
  onboardingCompleted  Boolean   @default(false)
  
  // Custom fields
  subscriptionPlan String   @default("free") // free, premium, family
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  accounts         Account[]
  sessions         Session[]
  weightEntries    WeightEntry[]
  connectedDevices ConnectedDevice[]
  meals            Meal[]
  mealPlans        MealPlan[]
  submittedRecipes Recipe[]  @relation("SubmittedRecipes")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Application Models

model WeightEntry {
  id              String   @id @default(cuid())
  userId          String
  weight          Float
  bodyFat         Float?
  muscleMass      Float?
  waterPercentage Float?
  bmi             Float?
  source          String   @default("manual") // manual, apple_health, google_fit, withings
  deviceName      String?
  notes           String?
  measuredAt      DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, measuredAt])
}

model ConnectedDevice {
  id          String    @id @default(cuid())
  userId      String
  deviceType  String    // scale, watch, etc.
  deviceBrand String    // apple, garmin, withings
  deviceName  String?
  platform    String    // apple_health, google_fit
  isConnected Boolean   @default(true)
  lastSyncAt  DateTime?
  permissions String?   // JSON string
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, deviceType, deviceBrand])
}

model Meal {
  id             String     @id @default(cuid())
  userId         String
  type           String     // breakfast, lunch, snack, dinner
  date           String     // YYYY-MM-DD
  time           String?    // HH:mm
  
  // Total Nutrition Snapshot
  calories       Float
  proteins       Float
  carbs          Float
  fats           Float
  fiber          Float?
  sugar          Float?
  sodium         Float?
  
  source         String     @default("manual") // manual, photo, ai, etc.
  photoUrl       String?
  notes          String?
  
  isPlanned      Boolean    @default(false)
  
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  user           User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items          MealItem[]

  @@index([userId, date])
}

model MealItem {
  id             String   @id @default(cuid())
  mealId         String
  
  // Food Details
  name           String
  quantity       Float
  unit           String   @default("g") // g, ml, serving
  
  // Nutrition Snapshot per item (total for quantity)
  calories       Float
  proteins       Float
  carbs          Float
  fats           Float
  
  foodId         String?  // Optional reference to a food catalog
  
  meal           Meal     @relation(fields: [mealId], references: [id], onDelete: Cascade)
}

// Meal Planning Models
model MealPlan {
  id        String   @id @default(cuid())
  userId    String
  startDate DateTime
  endDate   DateTime
  status    String   @default("active") // draft, active, completed, archived
  
  days      MealPlanDay[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model MealPlanDay {
  id         String @id @default(cuid())
  mealPlanId String
  date       DateTime
  
  meals      PlannedMeal[]
  
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
}

model PlannedMeal {
  id            String @id @default(cuid())
  mealPlanDayId String
  type          String // breakfast, lunch, snack, dinner

  // Recipe details (snapshot)
  title         String
  description   String?
  calories      Float
  proteins      Float
  carbs         Float
  fats          Float
  prepTime      Int

  isCompleted   Boolean @default(false)

  day           MealPlanDay @relation(fields: [mealPlanDayId], references: [id], onDelete: Cascade)
}

// Recipe Models - For AI-generated and community recipes
model Recipe {
  id            String   @id @default(cuid())

  // Recipe Details
  title         String
  description   String?
  imageUrl      String?
  prepTime      Int      // minutes
  cookTime      Int?     // minutes
  servings      Int      @default(2)
  difficulty    String   @default("medium") // easy, medium, hard

  // Nutrition per serving
  calories      Float
  proteins      Float
  carbs         Float
  fats          Float
  fiber         Float?

  // Recipe Content (JSON strings)
  ingredients   String   // JSON array of ingredients
  instructions  String   // JSON array of steps
  tags          String?  // JSON array of tags

  // Source & AI metadata
  source        String   @default("ai") // ai, youtube, instagram, community
  generatedBy   String   @default("gemini") // gemini, openai, manual
  promptContext String?  // What the user asked for

  // Video source fields (YouTube/Instagram)
  videoUrl      String?  // Original video URL
  videoId       String?  // Platform video ID
  thumbnailUrl  String?  // Video thumbnail
  videoPlatform String?  // youtube, instagram, tiktok
  transcript    String?  // Raw transcript for RAG

  // Community/Author fields
  authorId      String?
  author        User?    @relation("SubmittedRecipes", fields: [authorId], references: [id])
  status        String   @default("approved") // pending, approved, rejected

  // Aggregated ratings (cached for performance)
  averageRating Float    @default(0)
  ratingsCount  Int      @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  ratings       RecipeRating[]

  @@index([averageRating])
  @@index([createdAt])
  @@index([source, status, averageRating])
  @@index([authorId])
}

model RecipeRating {
  id        String   @id @default(cuid())
  recipeId  String
  userId    String

  // Rating (1-5 stars)
  rating    Int      // 1-5

  // Optional comment
  comment   String?

  // Was this recipe cooked?
  cooked    Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, userId]) // One rating per user per recipe
  @@index([userId])
}

// Gamification Models
model UserGamification {
  id              String   @id @default(cuid())
  userId          String   @unique

  // XP and Level
  totalXp         Int      @default(0)
  level           Int      @default(1)

  // Streaks
  currentStreak   Int      @default(0)
  longestStreak   Int      @default(0)
  lastActivityAt  DateTime?

  // Stats
  recipesRated    Int      @default(0)
  recipesCooked   Int      @default(0)
  mealsLogged     Int      @default(0)
  weightLogsCount Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  badges          UserBadge[]
  xpHistory       XpTransaction[]
}

model UserBadge {
  id               String   @id @default(cuid())
  userGamificationId String

  badgeType        String   // first_rating, streak_7, level_5, etc.
  badgeName        String
  badgeIcon        String?  // emoji or icon name
  description      String?

  earnedAt         DateTime @default(now())

  userGamification UserGamification @relation(fields: [userGamificationId], references: [id], onDelete: Cascade)

  @@unique([userGamificationId, badgeType])
}

model XpTransaction {
  id               String   @id @default(cuid())
  userGamificationId String

  amount           Int      // XP earned (positive) or spent (negative)
  reason           String   // rate_recipe, log_meal, streak_bonus, etc.
  referenceId      String?  // ID of related entity (recipe, meal, etc.)
  referenceType    String?  // recipe, meal, weight, etc.

  createdAt        DateTime @default(now())

  userGamification UserGamification @relation(fields: [userGamificationId], references: [id], onDelete: Cascade)

  @@index([userGamificationId, createdAt])
}
